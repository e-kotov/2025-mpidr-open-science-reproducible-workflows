{
  "hash": "3561659183732023623c435226ce7b6f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"1. R packages version management\"\nfrom: markdown+emoji\ncode-annotations: hover\neval: false\n---\n\n\n\n\n[Skip to exercise \\>\\>](#exercise)\n\n# Key packages summary\n\n\n|  |  |\n|--------------------------------|----------------------------------------------------|\n| [`{renv}`](#renv) | Sets up an R package library on a per-project level. Each project where you activate `renv` with [`renv::init()`](https://rstudio.github.io/renv/reference/init.html){target=\"_blank\"} will have it's own independent library with specific R package versions that will not interfere with either your default system/user libraries or with any other project. |\n| [`{pak}`](#pak) | Significantly speeds up R package installation by using multiple threads to download and install both requested packages and their dependencies. Can be used to install [CRAN](https://cran.r-project.org/){target=\"_blank\"} and [Bioconductor](https://www.bioconductor.org/){target=\"_blank\"} packages, as well as packages from GitHub or any other repository. Can be used independently from `{renv}`, or as a companion of `{renv}` . |\n: {tbl-colwidths=\"[15,85]\"}\n\n## `{renv}` {#renv}\n\n### What does `{renv}` do?\n\n[`{renv}`](https://rstudio.github.io/renv/){target=\"_blank\"} takes over the location of the R package installation and the command `install.packages()`. After initialising `{renv}` for a particular project/working directory, all your packages installations and removals will be taken care of by `{renv}`. From now on, whenever you use `install.packages()` in that project, `{renv}` will install the package into the project directory.\n\n::: callout-note\nActually, `{renv}` will install the packages into user cache folder defined by the operating system (this is different from the default user folder for R package installation), and will \"link\" the packages into your project (or projects) directory(-ies). For example, you have two projects with different versions of `{ggplot2}`, but the same versions of `{dplyr}`. The `{renv}` packages cache will have two versions of `{ggplot2}` and one version of `{dplyr}`. Your projects however, will only contain \"links\" to the cache, therefore, you will not have two identical copies of `{dplyr}` on disk in two project directories, as they will both just point to the cached version of `{dplyr}` in `{renv}`'s cache folder. You can read more about it [here](https://rstudio.github.io/renv/articles/package-install.html#cache){target=\"_blank\"}\n:::\n\n### Under the hood of `renv`\n\nWhen you install `{renv}` and run [`renv::init()`](https://rstudio.github.io/renv/reference/init.html){target=\"_blank\"} in the current project/working directory, it reates several files and directories in your current project/working directory (see @fig-renv-files).\n\n![Files and folders created by `renv` when initialized](media/images/renv-files.png){#fig-renv-files}\n\n-   `{renv}` creates an invisible `.Rprofile` text file your current project/working directory. This file may contain any R code, and when `R`/`RStudio` is started in that directory, the commands in this file get executed. `{renv}` adds a line `source(\"renv/activate.R\")` which runs a script that activates `{renv}` for this particular project every time `R`/`RStudio` is started in this directory.\n\n-   `{renv}` also creates an `renv` folder, where it will store all R scripts that it requires to function, and also the packages that you install for this particular project.\n\n-   `{renv}` also creates an `renv.lock` file, which stores the exact versions of R packages you install, as well as the sources where you install them from. That is, it keeps track if the package was installed from CRAN, Bioconductor, GitHub repository, or any other source.\n\n\n\n\n## `{pak}` {#pak}\n\n### What does `{pak}` do?\n\n[`{pak}`](https://pak.r-lib.org/){target=\"_blank\"} can be used instead of R's default `install.packages()` to install R packages and their dependencies faster.\n\nIt can also serve as a so-called \"backend\" for [`{renv}`](#renv), that is it will help `{renv}` to install packages and their dependencies much faster when you, or someone who reproduces your code, such as your collaborator, use [`{renv}`](#renv) to fully restore the R package environment of a project on a new computer.\n\n# Exercise {#exercise}\n\n## Goal\n\nThe goal of this exercise is setup a new blank project with isolated R packages library using [`{renv}`](#renv) and [`{pak}`](#pak) in such a way, so that all the specific package versions can be restored on a new computer or in a new folder.\n\n## Instructions\n\n### Create a new project folder\n\nCreate a new folder wherever you would normally create a folder for a new research project.\n\nIf you are using RStudio, use the menu `File -> New Project`, then select `New Directory -> New Project` and set the folder name and location. You may select `Use renv with this project` in the end of the project creation wizard, but we would advice to skip it for now, as we will set this up in the next step.\n\nIf you are using [`Visual Studio Code`](https://code.visualstudio.com/){target=\"_blank\"} or the new [`Positron`](https://positron.posit.co/){target=\"_blank\"} (the future replacement for `RStudio` based on `Visual Studio Code`), just create a folder manually and open it in the respective editor.\n\nIf you are using some other editor, follow the usual procedure you know to create a new project.\n\nIn any case, once you are ready, run the following command in the R console to make sure that the current working directory is the project directory you intended to create and use:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngetwd()\n```\n:::\n\n\n\n\n### Install `{renv}`\n\nInstall `{renv}` as you normally would. You should not install any other packages at this point, as after installing and initizalising `{renv}`, you would need to install then again, as R will start using your project directory as a package library and will not see any previously user-installed packages anymore.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"renv\")\n```\n:::\n\n\n\n\n\n### Initialise `{renv}`\n\nInitialise `{renv}` in the current project/working directory:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrenv::init()\n```\n:::\n\n\n\n\nYou should get a message like this (your `R` and `{renv}` versions may be different):\n\n```r\nThe following package(s) will be updated in the lockfile:\n\n# CRAN -----------------------------------------------------------------------\n- renv   [* -> 1.1.1]\n\nThe version of R recorded in the lockfile will be updated:\n- R      [* -> 4.4.3]\n\n- Lockfile written to \"path-to-your-project/renv.lock\".\n- renv activated -- please restart the R session.\n```\n\n::: {.callout-important}\nAt this point, you need to restart the R session for `{renv}` to work. Do not ignore this instruction, as otherwise the rest of the steps will not work.\n:::\n\nFeel free to double check if the `{renv}` related files have been created in your project, as was shown in @fig-renv-files in the previous section.\n\n### Install `{pak}` \n\nNow install `{pak}` as you normally would. We also suggest that you install `usethis` package, as it provides some useful functions to easily edit configuration some files and setup certain files in the project from templates:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(c(\"pak\", \"usethis\"))\n```\n:::\n\n\n\n\n::: {.callout-note}\nNote that even though you are using `install.packages()`, the installation process will look slightly different.\n\n```r\n# Downloading packages -------------------------------------------------------\n- Downloading jsonlite from CRAN ...            OK [1.1 Mb in 0.66s]\n- Downloading httr2 from CRAN ...               OK [718.6 Kb in 0.61s]\nSuccessfully downloaded 2 packages in 4.9 seconds.\n```\n\nYou will also be asked if you would like to install extra packages, to which you should agree. This is because `{renv}` is taking over the package installation process.\n\n```r\nThe following package(s) will be installed:\n- askpass     [1.2.1]\n- cli         [3.6.4]\n...\n- yaml        [2.3.10]\n- zip         [2.3.2]\nThese packages will be installed into \"path-to-your-project/renv/library/macos/R-4.4/aarch64-apple-darwin20\".\n\nDo you want to proceed? [Y/n]:\n```\n\n:::\n\n### Enable `{pak}` as a backend for `{renv}`\n\nTo make `{renv}` use `{pak}` as a \"backend\" and therefore install packages and their dependencies faster, you need to add another line to your `.Rprofile` file in the current project/working directory. Either locate and edit the file manually (you may need to enable the display of hidden files in your editor or system), or you can run this command to open it in the editor automatically:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nusethis::proj_set(\".\", force = TRUE) # force sets the current direcotry as a project\nusethis::edit_r_profile(\"project\") # opens the project level .Rprofile file in the editor\n```\n:::\n\n\n\n\nIn line with the [`{renv}` documentation](https://rstudio.github.io/renv/reference/config.html#renv-config-pak-enabled), add this line to the end of the file:\n\n```r\noptions(\"renv.config.pak.enabled\" = TRUE)\n```\n\n::: {.callout-warning}\n`{renv}`'s support for `{pak}` is still officially experimental, even though in practice it is quite stable. However, it may not work correctly in all cases. If something does not work, simply remove the line from the `.Rprofile` file. Everything will work fine without it, it's just that the package installation process will be slower.\n:::\n\n\nSo your new `.Rprofile` file should look like this:\n\n```r\nsource(\"renv/activate.R\")\noptions(\"renv.config.pak.enabled\" = TRUE)\n```\n\nAs these lines are only executed when `R` starts in the project directory, to apply it in the current `R` session, you will need to run the same command in the `R` console:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(\"renv.config.pak.enabled\" = TRUE)\n```\n:::\n\n\n\n\n::: {.callout-note}\nAlternatively, you can also restart the R session to make the changes take effect.\n:::\n\n### Try installing packages\n\nNow you can try to install a new package to see if `{renv}` works with `{pak}`. In the next exercise, we will need the `{targets}` package, so we can try installing it:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"targets\")\n```\n:::\n\n\n\n\nIf you have setup both `{renv}` and `{pak}` correctly, you should see a new interface of the package installation process. You will be presented with the installation plan (@fig-package-installation-process1) and asked to confirm.\n\n![Package installation process with `{renv}` and `{pak}` - installation plan preview](media/images/install-targets-with-renv-pak-1.png){#fig-package-installation-process1}\n\nOnce you confirm with \"Y\" and \"Enter/Return\", packages will be installed:\n\n![Package installation process with `{renv}` and `{pak}` - executing installation plan](media/images/install-targets-with-renv-pak-2.png){#fig-package-installation-process2}\n\nYou can check that the `{targets}` package is installed by trying to load it:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(targets)\n```\n:::\n\n\n\n\n::: callout-note\nIf you have not had `targets` installed prior to starting this exercise, it does not exist in your default user R library, but only exists in the `{renv}` R package cache and in the current project directory. If you would like to check this, you can start another `R`/`RStudio` session in a differnt project directory and try to load `targets` there. It should fail, as there is no `targets` package in the default user R library.\n:::\n\n### Save the package versions into lock file\n\nWhile you were installing packages as described above, `{renv}` was also quietly saving all the package verions and installation sources into the `renv.lock` file.\n\n\n### Test R packages restoration\n\nIn the steps above you have\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}